<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>人物原型坐标图 · Archetypes × Works</title>
<style>
  :root{
    --bg:#f7fafc; --ink:#0f172a; --muted:#475569; --accent:#2563eb;
    --grid:#e5e7eb; --card:#ffffff; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:14px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);z-index:2}
  h1{font-size:18px;margin:0}
  .wrap{
    display:grid;
    grid-template-columns: minmax(520px,1fr) 360px 340px; /* ← 三列 */
    gap:16px; padding:16px; max-width:1400px; margin:0 auto;
  }
    /* 小屏自动一列堆叠 */
  @media (max-width: 1100px){
    .wrap{ grid-template-columns: 1fr; }
  }
  .panel{background:var(--card);border:1px solid var(--border);border-radius:16px}
  #plot{padding:12px}
  #list{padding:12px;max-height:78vh;overflow:auto}

  /* 自适应 SVG */
  #svg{width:100%;height:auto;aspect-ratio:3/2;display:block}

  .plotbar{display:flex;align-items:center;gap:8px;padding:8px 12px 0 12px}
  .plotbar label{font-size:12px;color:#475569}
  .select{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#0f172a}

  .axisLabel{fill:var(--muted); font-size:12px}
  .tick text{fill:#64748b;font-size:10px}
  .tick line{stroke:var(--grid)}
  .domain{stroke:#cbd5e1}

  .node{ transition: opacity .12s ease; transform:none !important; }
  .node:hover{ opacity:1; stroke-width:2.2; }  /* 不再 scale */
  .node.selected{stroke:var(--accent) !important; stroke-width:2.8 !important}

  .nodeLabel{fill:#334155; font-size:11px; opacity:.9; pointer-events:none}
  .nodeLabel tspan.role{ fill:#475569; font-size:10px; opacity:.95 }
  .highlight{opacity:1 !important}
  .pulse{stroke:var(--accent); stroke-width:2; fill:transparent; opacity:.9; animation:pulse 1.2s ease-out infinite; pointer-events:none}
  @keyframes pulse {0%{r:0; opacity:.9} 80%{r:22; opacity:0} 100%{opacity:0}}

  .work{padding:10px 12px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px solid transparent}
  .work:hover{background:#f8fafc;border-color:#e5e7eb}
  .work.active{background:#eef2ff;border-color:#c7d2fe}
  .badge{background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:11px}
  .muted{color:var(--muted)}
  .toolbar{display:flex;gap:10px;align-items:center;padding:0 12px 12px}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#0f172a;outline:none}
  #legend{padding:12px;border-top:1px dashed var(--border)}
  #legend h3{font-size:12px;margin:0 0 8px;color:#0f172a}
  #legend .line{font-size:12px;color:#1f2937;margin:2px 0}
  #archRoles{padding:12px;border-top:1px dashed var(--border)}
  #archRoles h3{font-size:12px;margin:0 0 8px;color:#0f172a}
  #archRoles .line{font-size:12px;color:#1f2937;margin:2px 0}
  .axesNote{font-size:12px;color:#64748b;padding:0 12px 12px}
  #archNote{padding:12px;border-top:1px dashed var(--border)}
  #insights .insHead{ padding:12px 12px 0; font-size:12px; color:#475569; }
  #insights .insGrid{ display:grid; gap:12px; padding:12px; }
  #archRoles, #archNote{ border-top:1px dashed var(--border); padding-top:12px; }

  /* 你之前的样式可继续用： */
  #archRoles h3, #archNote h3{ font-size:12px; margin:0 0 8px; color:#0f172a; }
  #archRoles .line{ font-size:12px; color:#1f2937; margin:2px 0; }
  #archNote .text{ white-space:pre-wrap; color:#111827; font-size:12.5px; line-height:1.6; }

  /* === 字体调优补丁：左侧更大、更易读；右侧列表略小更紧凑 === */

  /* 左列：图表下方两块（坐标说明 & 角色映射/legend） */
  #plot .axesNote{
    font-size: 13.5px;
    line-height: 1.6;
  }
  #legend h3{
    font-size: 14px;
  }
  #legend .line{
    font-size: 13.5px;
    line-height: 1.7;
    letter-spacing: .1px;
  }

  /* 中列：原型洞见（全作品角色 + 原型注记） */
  #insights .insHead{
    font-size: 12.5px;
  }
  #archRoles h3, #archNote h3{
    font-size: 13.5px;
  }
  #archRoles .line{
    font-size: 13.5px;
    line-height: 1.65;
  }
  #archNote .text{
    font-size: 14px;
    line-height: 1.7;
    letter-spacing: .1px;
  }

  /* 右列：作品列表更紧凑一些 */
  #works .toolbar input[type="search"]{
    font-size: 13px;
    padding: 9px 12px;
  }
  #works .badge{
    font-size: 11px;
   padding: 2px 8px;
  }
  #works .work{
    padding: 8px 10px;             /* 更紧凑 */
  }
  #works .work > div{               /* 作品名 */
    font-size: 13px;
  }
  #works .work .muted{              /* “X 角色” 这个灰字 */
    font-size: 12px;
  }

  /* 如果你想让左侧图上“点旁边的标签”也稍大（可选） */
  .nodeLabel{
    font-size: 12px;                /* 原来是 11px */
  }
  .nodeLabel tspan.role{
    font-size: 11px;                /* 第二行人物名 */
  }
  /* 非交互层不接管鼠标，避免抢 hover */
  .nodeLabel,.pulse{ pointer-events:none; }
  #plot .tick line, #plot .domain{ pointer-events:none; } /* 网格/轴线 */
  .links line{ pointer-events:none; } /* 如果你给连线层起名不是 .links，忽略这条 */

  /* 圆点：别用 transform 放大，改成描边高亮（最稳） */
  .node{ transition: opacity .12s ease; transform:none; }
  .node:hover{ opacity:1; stroke-width:2.2; }
  /* 别用 transform 放大；用描边高亮 */
  .node{ transition: opacity .12s ease; transform:none; }
  .node:hover{ opacity:1; stroke-width:2.2; }

  /* 非交互层不抢鼠标 */
  .nodeLabel,.pulse{ pointer-events:none; }
  
  /* 三列：左=作品（可折叠），中=图表，右=洞见 */
:root{ --listw: 280px; --insw: 360px; }
.wrap{
  display:grid;
  grid-template-columns: var(--listw) 1fr var(--insw);
  gap:16px; padding:16px; max-width:1500px; margin:0 auto;
  transition: grid-template-columns .25s ease;
}
@media (max-width: 1100px){ .wrap{ grid-template-columns: 1fr; } }

/* 顶部按钮样式 */
header{ display:flex; align-items:center; gap:12px; }
#toggleList{
  border:1px solid var(--border); background:#fff; color:#0f172a;
  padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px;
}
#toggleList[aria-pressed="true"]{ background:#eef2ff; border-color:#c7d2fe; }

/* 折叠时：左列宽度=0，隐藏内容，图表+洞见变宽 */
body.list-collapsed{ --listw: 0px; }
body.list-collapsed #works{ opacity:0; padding:0; border-width:0; overflow:hidden; }
#works{ transition: opacity .2s ease, padding .2s ease, border-width .2s ease; }

/* 左边/中间的文字更大一点，右侧列表略紧凑 */
#legend h3, #archRoles h3, #archNote h3{ font-size: 14px; }
#legend .line, #archRoles .line{ font-size: 13.5px; line-height: 1.65; }
#archNote .text{ font-size: 14px; line-height: 1.7; }

#works .toolbar input[type="search"]{ font-size:13px; padding:9px 12px; }
#works .work{ padding:8px 10px; }
#works .work > div{ font-size:13px; }
#works .work .muted{ font-size:12px; }

/* 图上标签稍放大一点（可按需再调） */
.nodeLabel{ font-size:12.5px; }
.nodeLabel tspan.role{ font-size:11.5px; }

/* 防抖：非交互层不抢鼠标（确保保留） */
.nodeLabel,.pulse{ pointer-events:none; }

/* 顶部提示条 */
.notice{
  padding:10px 16px;
  background:#f1f5ff;              /* 淡蓝 */
  border:1px solid #dbe3ff;
  color:#0f172a;
  font-size:13px;
  line-height:1.6;
  border-radius:12px;
  max-width:1500px;
  margin:12px auto 0;
}
.notice strong{ color:#1d4ed8; }

</style>
</head>
<body>
<header>
  <button id="toggleList" aria-pressed="false" title="收起/展开作品列表">⟨ 作品</button>
  <h1>人物原型坐标图 · Archetypes × Works</h1>
</header>

<div class="notice">
  💡 小提示：左上角的<strong>「⟨ 作品」按钮</strong>可收起/展开左侧作品列表；
  点击<strong>图表中的任意原型点</strong>可在右侧查看「全作品角色」与「原型注记」；
  图表上方的<strong>「坐标系」下拉</strong>可在「主动/结构」与「轻/重 × 清/浊」之间切换。
</div>


<div class="wrap">
  <aside class="panel" id="works">
    <div class="toolbar">
      <input id="q" type="search" placeholder="搜索作品…">
      <span class="badge" id="count"></span>
    </div>
    <div id="list"></div>
  </aside>
  
  <section class="panel" id="plot">
    <div class="plotbar">
      <label for="axesSel">坐标系：</label>
      <select id="axesSel" class="select">
        <option value="base">主动/结构</option>
        <option value="tone">轻/重 × 清/浊</option>
      </select>
    </div>
    <svg id="svg"></svg>
    <div class="axesNote" id="axesNote">当前：横轴=主动程度（左=被动，右=主动） · 纵轴=对结构/体系的态度（下=反结构，上=亲结构）</div>
    <div id="legend"></div>
  </section>
  
  <section class="panel" id="insights">
  <div class="insHead">原型洞见</div>
  <div class="insGrid">
    <div id="archRoles"></div>
    <div id="archNote"></div>
  </div>
</section>


  </div>


<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
const POSITIONS = [{"archetype": "官杀男", "x": 100, "y": 90, "masc": 0.5, "parent": NaN, "x2": 60, "y2": 65}, {"archetype": "变种：社畜牛马命苦男妈妈", "x": 50, "y": 50, "masc": 0.8, "parent": "官杀男", "x2": 35, "y2": 20}, {"archetype": "变种：协助作恶者", "x": 0, "y": -20, "masc": 0.5, "parent": "官杀男", "x2": -35, "y2": -50}, {"archetype": "变种：高洁堕落者", "x": 30, "y": -30, "masc": 0.5, "parent": "官杀男", "x2": 60, "y2": -40}, {"archetype": "炽烈真诚野性大傻子", "x": 100, "y": 50, "masc": 0.8, "parent": NaN, "x2": -50, "y2": 80}, {"archetype": "女性变种：打女，不服咔咔就是干", "x": 100, "y": -30, "masc": 0.0, "parent": "炽烈真诚野性大傻子", "x2": -60, "y2": 70}, {"archetype": "变种：克制忠仆骑士", "x": -60, "y": 30, "masc": 0.9, "parent": "炽烈真诚野性大傻子", "x2": 60, "y2": 80}, {"archetype": "明亮自信伤官浪子", "x": 80, "y": 30, "masc": 0.5, "parent": NaN, "x2": -20, "y2": 60}, {"archetype": "变种：Trickstar", "x": 100, "y": -75, "masc": 0.5, "parent": "明亮自信伤官浪子", "x2": -80, "y2": -90}, {"archetype": "变种：狂气大叔", "x": 70, "y": -30, "masc": 1.0, "parent": "明亮自信伤官浪子", "x2": 70, "y2": -75}, {"archetype": "女性变种：有意的性感尤物", "x": 40, "y": -50, "masc": 0.0, "parent": "明亮自信伤官浪子", "x2": -30, "y2": -90}, {"archetype": "女性变种2：攻击性（对内对外异常的毁灭感和死本能）", "x": 100, "y": -100, "masc": 0.0, "parent": "明亮自信伤官浪子", "x2": 80, "y2": -90}, {"archetype": "阴郁雨中自毁大狗狗", "x": -40, "y": -20, "masc": 0.5, "parent": NaN, "x2": 80, "y2": -30}, {"archetype": "淋过雨后甩干还是好狗狗", "x": 40, "y": 20, "masc": 0.5, "parent": "阴郁雨中自毁大狗狗", "x2": 20, "y2": 30}, {"archetype": "变种：腹黑温雅助攻男二（出门面美人）", "x": -30, "y": 0, "masc": 0.6, "parent": "阴郁雨中自毁大狗狗", "x2": -30, "y2": 20}, {"archetype": "疯癫的贤者", "x": -50, "y": -100, "masc": 0.3, "parent": NaN, "x2": -90, "y2": 35}, {"archetype": "变种：反讽型叙事者 / 观察者", "x": 0, "y": -80, "masc": 0.5, "parent": "疯癫的贤者", "x2": 75, "y2": 0}, {"archetype": "大母神", "x": 0, "y": 50, "masc": 0.0, "parent": NaN, "x2": 0, "y2": -30}, {"archetype": "变种（预备）：明亮正向晨间剧女主，野草型", "x": 75, "y": 70, "masc": 0.0, "parent": "大母神", "x2": -50, "y2": 90}, {"archetype": "反叛/自我流放者", "x": 50, "y": -100, "masc": 0.5, "parent": NaN, "x2": -20, "y2": 30}, {"archetype": "彼得潘", "x": -90, "y": 0, "masc": 0.7, "parent": NaN, "x2": -95, "y2": 95}];
const WORKS = [{"name": "网球王子", "roles": {"官杀男": "手冢国光", "炽烈真诚野性大傻子": "千石清纯", "变种：克制忠仆骑士": "桦地", "明亮自信伤官浪子": "跡部景吾", "变种：狂气大叔": "越前南次郎", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "切原赤也", "阴郁雨中自毁大狗狗": "忍足侑士（？）", "变种：腹黑温雅助攻男二（出门面美人）": "不二周助", "大母神": "幸村精市？"}}, {"name": "死神", "roles": {"官杀男": "朽木白哉", "变种：社畜牛马命苦男妈妈": "浮竹十四郎", "炽烈真诚野性大傻子": "更木剑八/葛力姆乔", "女性变种：打女，不服咔咔就是干": "碎蜂", "变种：克制忠仆骑士": "茶渡泰虎", "明亮自信伤官浪子": "志波海燕", "变种：狂气大叔": "京乐春水", "女性变种：有意的性感尤物": "松本乱菊", "阴郁雨中自毁大狗狗": "阿散井恋次", "淋过雨后甩干还是好狗狗": "朽木露琪亚", "变种：腹黑温雅助攻男二（出门面美人）": "市丸银", "大母神": "卯之花烈", "变种（预备）：明亮正向晨间剧女主，野草型": "井上织姬", "反叛/自我流放者": "四枫院夜一"}}, {"name": "樱兰高校", "roles": {"官杀男": "凤镜夜", "变种：克制忠仆骑士": "恬前辈", "变种：Trickstar": "常陆院双子", "变种：腹黑温雅助攻男二（出门面美人）": "凤镜夜", "变种（预备）：明亮正向晨间剧女主，野草型": "春绯", "彼得潘": "须王环"}}, {"name": "恋与深空", "roles": {"官杀男": "黎深", "变种：社畜牛马命苦男妈妈": "黎深", "变种：高洁堕落者": "夏以昼（？）", "炽烈真诚野性大傻子": "风临野", "明亮自信伤官浪子": "秦彻", "变种：Trickstar": "秦彻双子", "淋过雨后甩干还是好狗狗": "祁煜", "变种：腹黑温雅助攻男二（出门面美人）": "沈星回", "变种（预备）：明亮正向晨间剧女主，野草型": "女主"}}, {"name": "明日方舟", "roles": {"官杀男": "德克萨斯", "变种：社畜牛马命苦男妈妈": "玛恩纳、棘刺", "变种：高洁堕落者": "乌尔比安（不是）", "炽烈真诚野性大傻子": "贾维、百炼嘉维尔", "女性变种：打女，不服咔咔就是干": "陈", "变种：克制忠仆骑士": "角峰", "明亮自信伤官浪子": "银灰？极境", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "幽灵鲨", "阴郁雨中自毁大狗狗": "爱国者（？）", "淋过雨后甩干还是好狗狗": "流明", "变种：腹黑温雅助攻男二（出门面美人）": "Logos", "疯癫的贤者": "拉普兰德", "变种：反讽型叙事者 / 观察者": "老鲤", "大母神": "黍", "变种（预备）：明亮正向晨间剧女主，野草型": "艾雅法拉"}}, {"name": "原神", "roles": {"官杀男": "雷电将军、凝光", "变种：社畜牛马命苦男妈妈": "钟离", "炽烈真诚野性大傻子": "荒泷一斗", "变种：克制忠仆骑士": "托马", "明亮自信伤官浪子": "胡桃、温迪", "变种：Trickstar": "林尼", "女性变种：有意的性感尤物": "水神？", "淋过雨后甩干还是好狗狗": "卡维、砂金", "变种：腹黑温雅助攻男二（出门面美人）": "神里绫人，八重神子", "大母神": "小草神", "变种（预备）：明亮正向晨间剧女主，野草型": "香菱", "反叛/自我流放者": "枫原万叶"}}, {"name": "COD二创", "roles": {"官杀男": "Keegan", "炽烈真诚野性大傻子": "Soap", "阴郁雨中自毁大狗狗": "Krueger", "变种：反讽型叙事者 / 观察者": "Ghost"}}, {"name": "红楼梦", "roles": {"变种：协助作恶者": "王夫人", "变种：高洁堕落者": "秦可卿", "炽烈真诚野性大傻子": "薛蟠", "女性变种：打女，不服咔咔就是干": "晴雯", "变种：克制忠仆骑士": "袭人", "明亮自信伤官浪子": "史湘云", "变种：Trickstar": "刘姥姥", "女性变种：有意的性感尤物": "凤姐", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "尤三姐", "淋过雨后甩干还是好狗狗": "小红", "变种：腹黑温雅助攻男二（出门面美人）": "宝钗", "疯癫的贤者": "一僧一道", "变种：反讽型叙事者 / 观察者": "焦大", "大母神": "刘姥姥", "变种（预备）：明亮正向晨间剧女主，野草型": "香菱", "反叛/自我流放者": "柳湘莲、惜春、妙玉", "彼得潘": "贾宝玉"}}, {"name": "士兵突击", "roles": {"官杀男": "伍六一", "变种：社畜牛马命苦男妈妈": "齐桓、指导员", "变种：高洁堕落者": "老马", "炽烈真诚野性大傻子": "许三多（？）", "明亮自信伤官浪子": "高城", "变种：Trickstar": "白铁军/甘小宁", "变种：狂气大叔": "袁朗", "淋过雨后甩干还是好狗狗": "成才（？）", "变种：腹黑温雅助攻男二（出门面美人）": "吴哲", "变种：反讽型叙事者 / 观察者": "许二和", "大母神": "史今", "彼得潘": "李梦"}}, {"name": "我的团长我的团", "roles": {"官杀男": "虞啸卿", "变种：社畜牛马命苦男妈妈": "郝兽医", "变种：协助作恶者": "唐基？", "变种：高洁堕落者": "虞啸卿", "炽烈真诚野性大傻子": "迷龙", "变种：克制忠仆骑士": "豆饼", "明亮自信伤官浪子": "何书光", "变种：Trickstar": "不辣", "阴郁雨中自毁大狗狗": "孟烦了", "变种：腹黑温雅助攻男二（出门面美人）": "阿译（啊？）", "疯癫的贤者": "龙文章", "变种：反讽型叙事者 / 观察者": "麦师傅", "大母神": "上官戒慈、郝兽医", "变种（预备）：明亮正向晨间剧女主，野草型": "小醉、小书虫", "反叛/自我流放者": "迷龙（前期）", "彼得潘": "全民协助"}}, {"name": "甄嬛传", "roles": {"官杀男": "皇后", "变种：社畜牛马命苦男妈妈": "敬妃", "变种：协助作恶者": "曹琴默", "变种：高洁堕落者": "安陵容", "女性变种：打女，不服咔咔就是干": "叶澜依", "变种：克制忠仆骑士": "流朱、苏培盛、温太医", "明亮自信伤官浪子": "华妃", "变种：Trickstar": "欣贵人", "女性变种：有意的性感尤物": "祺贵人", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "端妃", "阴郁雨中自毁大狗狗": "皇后", "淋过雨后甩干还是好狗狗": "浣碧", "变种：腹黑温雅助攻男二（出门面美人）": "书里那个特喜欢皇帝的", "变种：反讽型叙事者 / 观察者": "眉庄", "大母神": "槿汐", "变种（预备）：明亮正向晨间剧女主，野草型": "玉娆", "反叛/自我流放者": "叶澜依", "彼得潘": "果郡王"}}, {"name": "狂飙", "roles": {"官杀男": "安欣", "变种：协助作恶者": "老默", "炽烈真诚野性大傻子": "唐小虎", "阴郁雨中自毁大狗狗": "后期安欣", "变种：腹黑温雅助攻男二（出门面美人）": "高启盛", "疯癫的贤者": "徐江", "大母神": "高叶大姐"}}, {"name": "长安的荔枝", "roles": {"变种：克制忠仆骑士": "林邑奴", "明亮自信伤官浪子": "白客版苏谅", "大母神": "男主老婆", "变种（预备）：明亮正向晨间剧女主，野草型": "阿僮"}}, {"name": "哈利波特", "roles": {"官杀男": "麦格", "变种：社畜牛马命苦男妈妈": "卢平", "变种：协助作恶者": "小矮星彼得", "变种：高洁堕落者": "雷古勒斯·布莱克", "炽烈真诚野性大傻子": "海格、罗恩", "变种：克制忠仆骑士": "多比", "明亮自信伤官浪子": "小天狼星（前）", "变种：Trickstar": "韦斯莱双子", "变种：狂气大叔": "穆迪？", "女性变种：有意的性感尤物": "芙蓉·德拉库尔", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "贝拉特里克斯", "阴郁雨中自毁大狗狗": "斯内普", "淋过雨后甩干还是好狗狗": "Tom Felton版马尔福", "疯癫的贤者": "特里劳妮、卢娜", "大母神": "韦斯莱太太", "变种（预备）：明亮正向晨间剧女主，野草型": "赫敏", "反叛/自我流放者": "格林德沃", "彼得潘": "洛哈特，小天狼星（后期）"}}, {"name": "魔戒", "roles": {"官杀男": "阿拉贡", "变种：协助作恶者": "萨鲁曼", "变种：高洁堕落者": "Boromir", "炽烈真诚野性大傻子": "Sam", "明亮自信伤官浪子": "Legolas", "变种（预备）：明亮正向晨间剧女主，野草型": "王女"}}, {"name": "老友记", "roles": {"官杀男": "Monica", "变种：社畜牛马命苦男妈妈": "Ross", "炽烈真诚野性大傻子": "Joey", "明亮自信伤官浪子": "Janice", "淋过雨后甩干还是好狗狗": "Chandler", "疯癫的贤者": "Phoebe", "大母神": "Monica", "变种（预备）：明亮正向晨间剧女主，野草型": "Rachel", "彼得潘": "Ross"}}, {"name": "漫威复联", "roles": {"官杀男": "美国队长、黑豹", "变种：社畜牛马命苦男妈妈": "猎鹰", "炽烈真诚野性大傻子": "雷神", "女性变种：打女，不服咔咔就是干": "白寡妇", "明亮自信伤官浪子": "钢铁侠", "变种：Trickstar": "洛基", "变种：狂气大叔": "苏联队长？", "女性变种：有意的性感尤物": "黑寡妇", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "猩红女巫", "阴郁雨中自毁大狗狗": "冬兵", "变种：腹黑温雅助攻男二（出门面美人）": "奇异博士"}}, {"name": "漫威X战警", "roles": {"官杀男": "镭射眼", "变种：社畜牛马命苦男妈妈": "野兽", "炽烈真诚野性大傻子": "冰人（Iceman / Bobby Drake）", "变种：克制忠仆骑士": "钢力士（Colossus）", "变种：Trickstar": "Deadpool、快银", "变种：狂气大叔": "金刚狼", "女性变种：有意的性感尤物": "灵蝶、魔形女", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "黑凤凰", "淋过雨后甩干还是好狗狗": "魔形女", "大母神": "X教授、暴风女"}}, {"name": "DC", "roles": {"官杀男": "蝙蝠侠", "变种：高洁堕落者": "半边脸哥", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "小丑女", "变种：反讽型叙事者 / 观察者": "小丑", "大母神": "神奇女侠", "彼得潘": "闪电侠、绿灯侠"}}, {"name": "星际迷航AOS", "roles": {"官杀男": "Spock", "变种：社畜牛马命苦男妈妈": "McCoy", "女性变种：打女，不服咔咔就是干": "Uhura", "明亮自信伤官浪子": "Kirk", "变种：Trickstar": "Scotty", "彼得潘": "Chekov"}}, {"name": "卡巴莱", "roles": {"变种：社畜牛马命苦男妈妈": "Herr Schultz", "变种：协助作恶者": "纳粹军官", "变种：狂气大叔": "Sally后期", "女性变种：有意的性感尤物": "Sally前期", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "妓女姐姐", "变种：反讽型叙事者 / 观察者": "Emcee", "大母神": "房东太太？"}}, {"name": "汉密尔顿", "roles": {"官杀男": "Burr", "变种：社畜牛马命苦男妈妈": "华盛顿", "变种：高洁堕落者": "汉密尔顿", "炽烈真诚野性大傻子": "Laurence", "明亮自信伤官浪子": "杰斐逊", "变种：Trickstar": "乔治三世", "女性变种：有意的性感尤物": "Maria", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "Angelica（Congratulations段）", "变种：反讽型叙事者 / 观察者": "Burr兼职", "大母神": "Eliza", "变种（预备）：明亮正向晨间剧女主，野草型": "早期Eliza", "彼得潘": "Phillip"}}, {"name": "悲惨世界", "roles": {"官杀男": "安灼拉", "变种：社畜牛马命苦男妈妈": "冉阿让", "变种：高洁堕落者": "沙威", "女性变种：有意的性感尤物": "德纳第太太（虽然她颜值不行）", "淋过雨后甩干还是好狗狗": "艾潘妮", "变种：反讽型叙事者 / 观察者": "大R", "变种（预备）：明亮正向晨间剧女主，野草型": "珂赛特"}}, {"name": "冰雪奇缘", "roles": {"官杀男": "Elsa", "炽烈真诚野性大傻子": "Kristoff", "变种：克制忠仆骑士": "Olaf", "明亮自信伤官浪子": "Anna", "变种：Trickstar": "Olaf", "变种：腹黑温雅助攻男二（出门面美人）": "王子"}}, {"name": "头脑特工队", "roles": {"炽烈真诚野性大傻子": "Anger", "女性变种：打女，不服咔咔就是干": "Anger", "变种：克制忠仆骑士": "Bimbo", "女性变种：有意的性感尤物": "Disgust", "淋过雨后甩干还是好狗狗": "Sadness", "变种（预备）：明亮正向晨间剧女主，野草型": "Joy"}}, {"name": "双峰", "roles": {"变种：社畜牛马命苦男妈妈": "警长", "女性变种：有意的性感尤物": "Audrey", "阴郁雨中自毁大狗狗": "James Hurley", "疯癫的贤者": "木头小姐", "彼得潘": "Bobby"}}, {"name": "福尔摩斯", "roles": {"变种：社畜牛马命苦男妈妈": "华生", "炽烈真诚野性大傻子": "Lestrade", "明亮自信伤官浪子": "福尔摩斯", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "Irene Adler", "大母神": "Hudson"}}, {"name": "博德之门", "roles": {"官杀男": "莱埃泽尔", "炽烈真诚野性大傻子": "卡拉克", "女性变种：打女，不服咔咔就是干": "莱埃泽尔", "明亮自信伤官浪子": "威尔", "阴郁雨中自毁大狗狗": "阿斯代伦", "淋过雨后甩干还是好狗狗": "影心", "变种：腹黑温雅助攻男二（出门面美人）": "Gale"}}, {"name": "夜班奴隶", "roles": {"官杀男": "陆泽远", "变种：协助作恶者": "杜尚荣", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "梅星河", "阴郁雨中自毁大狗狗": "齐渊", "变种：腹黑温雅助攻男二（出门面美人）": "白辰", "疯癫的贤者": "阿清", "大母神": "陆萍", "彼得潘": "卫承龙"}}];
const NOTES     = {"官杀男": "典型官杀男，遵从规则，严于律己，理想主义，极端守序，智力可能会高，但脑子多少有点死性。会很容易因为上述性格特质成为成功、优秀、令人尊敬的人，但也经常因此把自己逼到墙角。", "变种：社畜牛马命苦男妈妈": "社会化很好的官杀男，在坚守自己的同时能够体谅他人，比官杀男要柔韧很多，代价就是经常会在局中被挤成尴尬的老好人（其实他们很有原则）。", "变种：协助作恶者": "同样是官杀基底，但眼界过窄、情商过低，导致他们对秩序和权威的服从压倒了人性，成为被体系异化和磋磨的一部分。想要归顺体系的人，往往最后也死于体系本身。", "变种：高洁堕落者": "纠结了一下沙威算协助作恶还是高洁堕落，感觉还是高洁堕落比较多一些。这一类人很大程度上是被命运玩弄，当他们所信服的东西背叛了他们，他们便无法抗拒地走向自我的毁灭。", "炽烈真诚野性大傻子": "每个人都会想要的酒友，日常生活中会给你带来无限的烦恼，但只要他在，你就能感受到一阵荒野吹来的不羁的风。说他们大傻子并不是恶评，而是他们的诚挚注定无法与现代社会相容。", "女性变种：打女，不服咔咔就是干": "女性限定，因为在真诚野性的同时加上了更多更大的压力，所以复仇系打女很多都拥有幼狮般的眼神，当社会不可能接纳她们，她们就用手撕出一条路。坚定然而单薄，社会化程度比较低，是有点少女哪吒的味道。一般只会出现在一定时段。", "变种：克制忠仆骑士": "大傻子原型的内敛版本，和官杀类的区别就是他们的主动性相对比较低，视野相对比较窄，比起天下、理想、社会，他们更想保护好眼前自己珍重的人。永远不会是叙事中心，但总会让人心疼。", "明亮自信伤官浪子": "官杀男永远的好CP，我永远坚定的第二xp。和大傻子的区别就在于他们不傻，他们是见过丑陋也经历过磋磨，仍然选择把酒放歌的一群人。内核稳定，大气敞亮，有让每个人都在他们的场子里感到自在的能力。", "变种：Trickstar": "比起伤官浪子更轻盈也更顽皮的一类人，经常以双子或双人组的方式出现，符号化相对比较强。喜欢搞事、喜欢热闹、喜欢欢笑，群戏里没有他们会变得很无聊。", "变种：狂气大叔": "伤官浪子们在30岁以后见过丑陋和磋磨的十几年之后变成的模样，会不再在意很多面上的东西，更加随性洒脱、放浪不羁，坏习惯也相对多一点，但非常自洽和坦然。只在必要的时候靠谱。", "女性变种：有意的性感尤物": "“圣女与荡妇”之中的荡妇，但在现代的诠释里往往会利用自己的性感来达成自己的目的，而这并不与她们有脑子、有计划、有梦想相冲突。最典型的是双峰里的Audrey，而她们往往需要付出额外的努力来证明自己。归根结底，最近的路往往最远，而她们必须学会使用除了性感以外的东西来走得更远。", "女性变种2：攻击性（对内对外异常的毁灭感和死本能）": "阁楼上的疯女人，女性情绪力量爆发的巅峰，混乱、失控、攻击、死亡，在荒诞的世界存活就要和荒诞一起大笑。疯狂是她们的通行证，也是她们的墓志铭。她们得以存活，也因此而死。但总要有人喊出这世界有多荒诞。", "阴郁雨中自毁大狗狗": "他们的世界下过一场雨，从此他们再也没从那场雨里走出来。他们经历过糟糕的事情，见过死亡与背叛，见过自己梦想的破碎，羞耻与罪恶从此在他们的心底扎根，他们不断质疑自己为什么还活着，但他们的确还活着。他们拖着自己，一步一步向前走。", "淋过雨后甩干还是好狗狗": "他们的世界也下过一场雨，但他们拼尽全力往前跑，终于跑出了那场雨。他们比雨中大狗更坚定、更勇敢，也是因为某种灵魂上的轻盈，让他们带着过去的伤痛和错误，却仍能怀抱希望去追逐下一个日出。", "变种：腹黑温雅助攻男二（出门面美人）": "他们的世界也下过一场雨，但他们回到雨里，给其他人打伞。他们见过糟糕的事情，因此理解灰色、进入灰色、安于灰色，常常后退一步站在局边，只在必要的时候伸手翻转棋局。在其他时候，他们更喜欢身居事外，观棋不语。", "疯癫的贤者": "比起阁楼上的疯女人攻击力低了很多，也不像自我流放者那样拒绝。他们只是游离于叙事之外，但不忍往往让他们即使看得再清楚也要再次入局。他们不在乎世俗标准，会活出最自我的样子，常常令人非常不习惯，但他们不在乎。因为他们说的疯话永远会实现。", "变种：反讽型叙事者 / 观察者": "比起疯癫贤者来说，他们的反讽更像一种自我保护，在声称自己不在乎、声称自己看得清，声称这一切有多好笑，但这些只体现出他们横跨局中局外，进不去又出不来。他们舌灿莲花操纵叙事，但往往除了这些以外身无凭依，以此掩盖自己的孤独。", "大母神": "母性、庇护、滋养，但并不等于温顺，相反在需要的时候有着巨大的土地力量，包容万物、生养万物，也能吞噬万物。地势坤，君子以厚德载物。太常见了不解释。", "变种（预备）：明亮正向晨间剧女主，野草型": "太常见了，千禧年代偶像剧必备，带着一股经济上行时代的希望感。干净，清澈，像一根野草一样无论来自什么样的过去，都能坚韧地开出花来。比起甩干小狗要更柔软，多一点理想主义的天真，让人想要守护，也让人相信她们可以面对风雨，闯过风浪。", "反叛/自我流放者": "比起打女要更决绝的一批人，打女还跟你打，他们直接不玩了。他们对世界有着最强烈的拒绝，万物皆为刍狗，权威、亲友、自己，皆是如此。与其身陷污泥，不如转身离去。", "彼得潘": "在这里是轻微贬义（但我不讨厌）。情绪价值拉满，要干活儿的时候永远找不着他们。柔软、浪漫、甜美，但一切都被封在成年之前（主动或被动），像是一场夏日的幻梦，温柔精致但屁用没有，这就是传说中的男人至死是少年吧！"};   // NEW

// 折叠按钮逻辑 + 记忆上次状态
const btn = document.getElementById('toggleList');
const LS_KEY = 'listCollapsed';
const saved = localStorage.getItem(LS_KEY) === '1';
if (saved) { document.body.classList.add('list-collapsed'); btn.setAttribute('aria-pressed','true'); btn.textContent = '⟩ 作品'; }

btn.addEventListener('click', () => {
  const collapsed = document.body.classList.toggle('list-collapsed');
  btn.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
  btn.textContent = collapsed ? '⟩ 作品' : '⟨ 作品';
  localStorage.setItem(LS_KEY, collapsed ? '1' : '0');

  // 触发一次重排（可选）
  window.dispatchEvent(new Event('resize'));
});


// 两套坐标配置
const AXES = [
  { id:'base', xKey:'x',  yKey:'y',
    xText:'主动程度  ⟵ 被动 ｜ 主动 ⟶',
    yText:'对结构/体系的态度  ⟵ 反结构 ｜ 亲结构 ⟶',
    note:'当前：横轴=主动程度（左=被动，右=主动） · 纵轴=对结构/体系的态度（下=反结构，上=亲结构）'
  },
  { id:'tone', xKey:'x2', yKey:'y2',
    // 你要求：轻在右、重在左 → x 取相反数；清在上、浊在下 → y 保持正向
    xSign: -1, ySign: 1,
    xText:'重  ⟵           ｜           轻  ⟶',
    yText:'浊  ⟵           ｜           清  ⟶',
    note:'当前：横轴=轻/重（左=重，右=轻） · 纵轴=清/浊（下=浊，上=清）'
  }
];
let CUR = AXES[0];

// ---------- SVG & 尺寸（右侧 GUTTER 专供标签） ----------
const svg = d3.select("#svg")
  .attr("viewBox", "0 0 960 640")
  .attr("preserveAspectRatio", "xMidYMid meet");
const width = 960, height = 640;
const GUTTER = 160;
const margin = {top:20, right:20, bottom:35, left:35};
let w = width  - margin.left - margin.right - GUTTER;
let h = height - margin.top  - margin.bottom;

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

// 颜色：masc 0=红(更女性化) → 1=蓝(更男性化)
const color = d3.scaleSequential(d3.interpolateRdBu).domain([0,1]);

// 裁剪主绘图区（点/线不越界）
svg.append("defs").append("clipPath").attr("id","plotClip")
  .append("rect").attr("x", margin.left).attr("y", margin.top).attr("width", w).attr("height", h);

// 箭头 marker
svg.append("defs").append("marker")
  .attr("id","arrow").attr("viewBox","0 0 10 10")
  .attr("refX",10).attr("refY",5).attr("markerWidth",6).attr("markerHeight",6)
  .attr("orient","auto-start-reverse")
  .append("path").attr("d","M 0 0 L 10 5 L 0 10 z").attr("fill","#60a5fa").attr("opacity",0.8);

// ---- 坐标/网格
const x = d3.scaleLinear().domain([-100,100]).range([0,w]);
const y = d3.scaleLinear().domain([-100,100]).range([h,0]);

const grid = g.append("g");
const gx = g.append("g").attr("transform",`translate(0,${h})`);
const gy = g.append("g");

const zeroX = g.append("line").attr("stroke","#cbd5e1").attr("stroke-dasharray","3,3");
const zeroY = g.append("line").attr("stroke","#cbd5e1").attr("stroke-dasharray","3,3");

// 右侧 GUTTER 背景 + 分隔线
const gutterBg = g.append("rect").attr("fill", "#f8fafc");
const gutterLine = g.append("line").attr("stroke", "#e5e7eb").attr("stroke-dasharray", "2,4");

// 轴标签
const xLabel = svg.append("text").attr("class","axisLabel").attr("text-anchor","middle");
const yLabel = svg.append("text").attr("class","axisLabel").attr("text-anchor","middle").attr("transform","rotate(-90)");
const axesNote = d3.select("#axesNote");

// ---- 数据：变种→原型链接
const ARCH_INDEX = new Map(POSITIONS.map(d => [d.archetype, d]));
const linksData = POSITIONS.filter(d => d.parent && String(d.parent).trim().length > 0)
  .map(d => ({ source: d, target: ARCH_INDEX.get(d.parent) })).filter(l => l.target);

const childCount = {};
linksData.forEach(l => { childCount[l.target.archetype] = (childCount[l.target.archetype] || 0) + 1; });

// ---- 图层
const linkLayer  = g.append("g").attr("clip-path","url(#plotClip)").style("pointer-events","none");
const nodeLayer  = g.append("g").attr("clip-path","url(#plotClip)");
const pulseLayer = g.append("g").attr("clip-path","url(#plotClip)");
const labelLayer = g.append("g"); // 不裁剪：标签可伸到 GUTTER
gutterBg.style("pointer-events","none");
gutterLine.style("pointer-events","none");
linkLayer.style("pointer-events","none");
labelLayer.style("pointer-events","none");
pulseLayer.style("pointer-events","none");

// 链接
const linkSel = linkLayer.selectAll("line").data(linksData).join("line")
  .attr("stroke", "#9ec5fe").attr("stroke-width", 1.5).attr("opacity", 0.7)
  .attr("marker-end", "url(#arrow)");

// 点
const nodeSel = nodeLayer.selectAll("circle").data(POSITIONS, d=>d.archetype).join("circle")
  .attr("class","node")
  .attr("r", d => childCount[d.archetype] ? 8 : 6)
  .attr("data-arch", d => d.archetype)
  .attr("fill", d => color(+d.masc))
  .attr("stroke", "#0b111a").attr("stroke-width", 1.2);
  
// 工具：取当前坐标值
const getXv = d => (CUR.xSign || 1) * (+d[CUR.xKey]);
const getYv = d => (CUR.ySign || 1) * (+d[CUR.yKey]);  
  
// 命中半径（看起来 8/6，命中圈再大 8px 比较顺手）
const baseR = d => (childCount[d.archetype] ? 8 : 6);

const hitLayer = g.append("g").attr("clip-path","url(#plotClip)");
const hits = hitLayer.selectAll("circle")
  .data(POSITIONS, d=>d.archetype)
  .join("circle")
    .attr("cx", d => x(getXv(d)))
    .attr("cy", d => y(getYv(d)))
    .attr("r",  d => Math.max(baseR(d) + 8, 12))
    .attr("fill", "transparent")
    .style("pointer-events","all")
    .style("cursor","pointer");

// hover 只改可见圆的样式，不改变大小/几何
hits.on("mouseenter", (e,d)=>{
  d3.select(nodeSel.filter(n => n===d).node())
    .attr("opacity", 1)
    .attr("stroke-width", 2.2);
}).on("mouseleave", (e,d)=>{
  d3.select(nodeSel.filter(n => n===d).node())
    .attr("opacity", .9)
    .attr("stroke-width", 1.2);
});

// 点击沿用你原先的逻辑（选中原型 & 显示两块信息）
hits.on("click", (e,d)=>{
  if (selectedArch === d.archetype){
    selectedArch = null;
    nodeSel.classed("selected", false);
    renderArchRoles(null);
  } else {
    selectedArch = d.archetype;
    nodeSel.classed("selected", n => n.archetype === selectedArch);
    renderArchRoles(selectedArch);
  }
});

// 标签
const labelSel = labelLayer.selectAll("text").data(POSITIONS, d=>d.archetype).join("text")
  .attr("class","nodeLabel")
  .each(function(d){ const t = d3.select(this); t.text(null); t.append("tspan").attr("class","arch").text(d.archetype); });



// 布局：默认点右侧；出主区则放入 GUTTER；底部溢出则翻到上方
function layoutOne(sel, d){
  const cx = x(getXv(d)), cy = y(getYv(d));
  let labelX = cx + 8, baseY = cy + 4;
  if (labelX > w - 8) labelX = w + 8; // 放进 GUTTER
  sel.attr("text-anchor","start").attr("x", labelX).attr("y", baseY);
  sel.select("tspan.arch").attr("x", labelX).attr("dy", 0);
  const role = sel.select("tspan.role"); const hasRole = !!role.node();
  if (hasRole) role.attr("x", labelX).attr("dy", 14);
  const box = sel.node().getBBox();
  if (cy + 6 + box.height > h) {
    sel.attr("y", cy - 6);
    sel.select("tspan.arch").attr("dy", 0);
    if (hasRole) role.attr("dy", -14);
  }
}
function layoutAll(){ labelSel.each(function(d){ layoutOne(d3.select(this), d); }); }

// 初始渲染（不带动画）
function positionAll(noAnim=false){
  const s = noAnim ? (sel=>sel) : (sel=>sel.transition().duration(500).ease(d3.easeCubicOut));
  s(nodeSel).attr("cx", d => x(getXv(d))).attr("cy", d => y(getYv(d)));
  s(linkSel) .attr("x1", d => x(getXv(d.source))).attr("y1", d => y(getYv(d.source)))
             .attr("x2", d => x(getXv(d.target))).attr("y2", d => y(getYv(d.target)));
  s(hits)    .attr("cx", d => x(getXv(d))).attr("cy", d => y(getYv(d)));   // ← 新增

  // 标签即时定位（不动画，避免抖动）
  layoutAll();
}

// 布局固定元素（轴/网格/零线/标签文字等）
function layoutStatic(){
  x.range([0,w]); y.range([h,0]);
  grid.selectAll("*").remove();
  grid.append("g").call(d3.axisBottom(x).tickSize(-h).ticks(10)).attr("transform",`translate(0,${h})`);
  grid.append("g").call(d3.axisLeft(y).tickSize(-w).ticks(10));

  gx.selectAll("*").remove(); gy.selectAll("*").remove();
  gx.call(d3.axisBottom(x).ticks(5)).attr("transform",`translate(0,${h})`);
  gy.call(d3.axisLeft(y).ticks(5));

  zeroX.attr("x1",x(0)).attr("x2",x(0)).attr("y1",0).attr("y2",h);
  zeroY.attr("y1",y(0)).attr("y2",y(0)).attr("x1",0).attr("x2",w);

  gutterBg.attr("x", w).attr("y", 0).attr("width", 160).attr("height", h);
  gutterLine.attr("x1", w).attr("x2", w).attr("y1", 0).attr("y2", h);

  xLabel.attr("x", margin.left + w/2).attr("y", height-6).text(CUR.xText);
  yLabel.attr("x", - (margin.top + h/2)).attr("y", 14).text(CUR.yText);
  axesNote.text(CUR.note);
}

// 先布局静态，再定位元素
layoutStatic();
positionAll(true);

// ---- Works 列表/交互（支持锁定） -------------------------------------
const list = d3.select("#list");
const count = d3.select("#count");
const legend = d3.select("#legend");
const rolesBox = d3.select("#archRoles");
const noteBox = d3.select("#archNote");
const q = document.getElementById('q');
const axesSel = document.getElementById('axesSel');

let lockedWork = null;    // 当前锁定的作品
let currentList = WORKS;  // 当前列表
let selectedArch = null;  // 当前选中的原型

function renderList(items){
  currentList = items;
  list.selectAll("*").remove();
  const row = list.selectAll(".work")
    .data(items, d=>d.name)
    .join("div")
    .attr("class","work")
    .classed("active", d => lockedWork && lockedWork.name === d.name)
    .on("mouseenter", (e,d)=> { if(!lockedWork) highlightWork(d); })
    .on("mouseleave", () => { if(!lockedWork) clearHighlight(); })
    .on("click", (e,d) => {
      if (lockedWork && lockedWork.name === d.name) { setLockedWork(null); }
      else { setLockedWork(d); }
    });
  row.append("div").text(d=>d.name);
  row.append("span").attr("class","muted").text(d=> Object.keys(d.roles).length + " 角色");
  count.text(items.length + " 部作品");
}
renderList(WORKS);

function setLockedWork(work){
  lockedWork = work;
  list.selectAll(".work").classed("active", d => lockedWork && d.name === lockedWork.name);
  if (lockedWork) highlightWork(lockedWork); else clearHighlight();
}

function applyRoleLines(roles){
  labelSel.each(function(d){
    const t = d3.select(this);
    t.selectAll("tspan.role").remove();
    const who = roles[d.archetype];
    if (who){ t.append("tspan").attr("class","role").text(who); }
  });
  layoutAll();
}

function clearHighlight(){
  nodeSel.classed("highlight", false).attr("opacity", .9).attr("stroke-width", 1.2);
  linkSel.attr("stroke", "#9ec5fe").attr("opacity",0.7);
  pulseLayer.selectAll("*").remove();
  legend.selectAll("*").remove();
  applyRoleLines({});
  layoutAll();
}

function highlightWork(work){
  clearHighlight();
  const roles = work.roles;
  const entries = Object.entries(roles);
  const toHi = new Set(entries.map(([arch]) => arch));
  entries.forEach(([arch])=>{ const p = ARCH_INDEX.get(arch)?.parent; if (p) toHi.add(p); });

  nodeSel.each(function(d){
    const isHi = toHi.has(d.archetype);
    d3.select(this).classed("highlight", isHi)
      .attr("opacity", isHi ? 1 : 0.35)
      .attr("stroke-width", isHi ? 2 : 1.2);
    if (isHi){
      pulseLayer.append("circle").attr("class","pulse")
        .attr("cx", x(getXv(d))).attr("cy", y(getYv(d))).attr("r", 0);
    }
  });

  linkSel
    .attr("stroke", d => (toHi.has(d.source.archetype) || toHi.has(d.target.archetype)) ? "#60a5fa" : "#9ec5fe")
    .attr("opacity", d => (toHi.has(d.source.archetype) || toHi.has(d.target.archetype)) ? 0.95 : 0.35);

  applyRoleLines(roles);

  legend.append("h3").text(work.name + " · 角色映射");
  entries.sort((a,b)=> a[0].localeCompare(b[0], 'zh-Hans-CN')).forEach(([arch, who])=>{
    legend.append("div").attr("class","line").text(arch + "： " + who);
  });
}

// 点击原型点：显示“全作品角色”
function renderArchRoles(arch){
  // 先清空
  rolesBox.selectAll("*").remove();
  noteBox.selectAll("*").remove();
  if (!arch) return;

  // 1) 全作品角色
  const items = [];
  WORKS.forEach(w => { if (w.roles[arch]) items.push({work:w.name, who:w.roles[arch]}); });
  rolesBox.append("h3").text(`${arch} · 全作品角色（${items.length}）`);
  items.forEach(it => rolesBox.append("div").attr("class","line").text(`${it.work}： ${it.who}`));

  // 2) 原型注记（来自 NOTES）
  const txt = NOTES[arch];
  noteBox.append("h3").text(`${arch} · 原型注记`);
  noteBox.append("div").attr("class","text").text(txt ? txt : "（暂无笔记）");
}
nodeSel.on("click", (e,d) => {
  if (selectedArch === d.archetype){
    selectedArch = null;
    nodeSel.classed("selected", false);
    renderArchRoles(null);
  } else {
    selectedArch = d.archetype;
    nodeSel.classed("selected", n => n.archetype === selectedArch);
    renderArchRoles(selectedArch);
  }
});

// 搜索
q.addEventListener('input', () => {
  const term = q.value.trim().toLowerCase();
  const filtered = term ? WORKS.filter(w => w.name.toLowerCase().includes(term)) : WORKS;
  renderList(filtered);
  if (lockedWork) { setLockedWork(lockedWork); }
});

// 切换坐标系
axesSel.addEventListener('change', (e)=>{
  const id = e.target.value;
  CUR = AXES.find(a => a.id === id) || AXES[0];
  // 更新轴标签/注释
  layoutStatic();
  // 清除脉冲，按新坐标重绘位置
  pulseLayer.selectAll("*").remove();
  positionAll(false);
  // 若有锁定作品，按新坐标重新高亮
  if (lockedWork) highlightWork(lockedWork);
});

function layoutStatic(){
  // 这些尺寸不变时只更新文本；若你想将来支持改比例/GUTTER，也可在这里重算 w/h
  x.range([0,w]); y.range([h,0]);
  grid.selectAll("*").remove();
  grid.append("g").call(d3.axisBottom(x).tickSize(-h).ticks(10)).attr("transform",`translate(0,${h})`);
  grid.append("g").call(d3.axisLeft(y).tickSize(-w).ticks(10));
  gx.selectAll("*").remove(); gy.selectAll("*").remove();
  gx.call(d3.axisBottom(x).ticks(5)).attr("transform",`translate(0,${h})`);
  gy.call(d3.axisLeft(y).ticks(5));
  zeroX.attr("x1",x(0)).attr("x2",x(0)).attr("y1",0).attr("y2",h);
  zeroY.attr("y1",y(0)).attr("y2",y(0)).attr("x1",0).attr("x2",w);
  gutterBg.attr("x", w).attr("y", 0).attr("width", 160).attr("height", h);
  gutterLine.attr("x1", w).attr("x2", w).attr("y1", 0).attr("y2", h);
  xLabel.attr("x", margin.left + w/2).attr("y", height-6).text(CUR.xText);
  yLabel.attr("x", - (margin.top + h/2)).attr("y", 14).text(CUR.yText);
  d3.select("#axesNote").text(CUR.note);
}
</script>
</body>
</html>